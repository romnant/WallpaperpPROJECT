<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <style>
        body {
            background-color: #000;
            margin: 0;
            padding: 0;
            overflow: hidden;
            text-align: center;
        }

        #cvs {
            display: none;
        }

        #display {
            margin: auto;
        }
    </style>
</head>

<body>
    <canvas id="cvs" width="1920" height="1080"></canvas>
    <canvas id="display"></canvas>
    <script>
        var cvs = document.getElementById("cvs");
        var ctx = cvs.getContext("2d");

        var display = document.getElementById("display");
        var displayCtx = display.getContext("2d");

        window.onresize = function () {
            display.width = window.innerHeight / 1080 * 1920;
            display.height = window.innerHeight;
        }

        window.onresize();

        var bg = new Image();
        bg.src = "bg.png";

        var mask = new Image();
        mask.src = "mask.png"

        var light = new Image();
        light.src = "light.png";
        light.style.mixBlendMode = "overlay";

        var caidai = new Image();
        caidai.src = "caidai.png";

        var two = new Image();
        two.src = "22.png";

        var screen = new Image();
        screen.src = "screen.png";

        /*window.wallpaperPropertyListener = {
            applyUserProperties: function (properties) {
                // Read single selected image
                if (properties.screenFile) {
                    if (properties.screenFile.value) {
                        screen.src = 'file:///' + properties.screenFile.value;
                    }
                }
            }
        }*/




        var screenBorder = new Image();
        screenBorder.src = "screenborder.png";

        var angle = 7;
        var l = 3;
        var data = new Array(128);
        var animData = new Array(128);

        for (var i = 0; i < 128; i++) {
            data[i] = animData[i] = 0;
        }

        var peakValue = 1;
        if (window.wallpaperRegisterAudioListener) {
            window.wallpaperRegisterAudioListener(function (audioData) {
                var max = 0;

                for (var i = 0; i < 128; i++) {
                    if (audioData[i] > max)
                        max = audioData[i];
                }
                //按照音量的大小自适应动画长度提高低音量的显示效果
                //peakValue = peakValue * 0.99 + max * 0.01;
                //使用可视化变量增益函数后使用自适应会导致音量低谷期失真

                /*for (i = 0; i < 64; i++) {
                    data[63 - i] = audioData[i] / peakValue;
                }//左声道倒转
                
                for (i = 0; i < 64; i++) {
                    data[127 - i] = audioData[127 - i] / peakValue;
                }//右声道*/
                
                /*for (i = 0; i < 64; i++) {
                    data[63 - i] = audioData[i * 2] / peakValue;
                }

                for (i = 0; i < 64; i++) {
                    data[127 - i] = audioData[i * 2 + 1] / peakValue;
                }*/
                for (i = 0; i < 64; i++) {
                    data[i * 2] = audioData[i] / peakValue * ((64 - i) * (64 - i) * Math.sqrt(Math.sqrt(64 - i)) + 1000) / 1000;
                }

                //右声道，偶数坐标
                for (i = 0; i < 64; i++) {
                    data[i * 2 + 1] = audioData[i + 64] / peakValue * ((64 - i) * (64 - i) * Math.sqrt(Math.sqrt(64 - i)) + 1000) / 1000;
                }

            });
        } 
        /*else {
            var iva = setInterval(() => {
                for (var i = 0; i < 128; i++) {
                    data[i] = Math.random();
                }
            }, 10);
        }*/

        function min(a, b) {
            return a > b ? b : a;
        }

        function render() {
            for (var i = 0; i < 128; i++) {
                animData[i] += (data[i] - animData[i]) * 0.3;
                animData[i] = min(animData[i], 1);
            }
             //绘制背景
            ctx.clearRect(0, 0, 1980, 1080);
            ctx.drawImage(bg, 0, 0);
            
            //绘制显示器内容
            ctx.transform(1, -8.21 * (Math.PI / 180), 0, 1, -1041, -210);
            ctx.drawImage(screen, 0, 0, 1280, 720);
            ctx.resetTransform();
            
            //绘制显示器边框
            ctx.drawImage(screenBorder, 0, 0);
            ctx.drawImage(mask, 954, 99);
            
            //绘制时间
            ctx.fillStyle = "#778d9b";
            ctx.font = "36pt Impact";

            ctx.transform(1, 2.05 * (Math.PI / 180), 0, 1, 0, 0);
            var time = new Date();
            ctx.fillText((time.getHours() < 10 ? "0" : "") + time.getHours().toString() + ":" + (time.getMinutes() < 10 ? "0" : "") + time.getMinutes() + ":" + (time.getSeconds() < 10 ? "0" : "") + time.getSeconds().toString(), 715, 320);
            ctx.resetTransform();

            ctx.fillStyle = "#778d9b";
            ctx.font = "31.02pt 华文仿宋";

            //日历本内容倾斜度和坐标
            ctx.transform(0.97, 0, 1.8 * (Math.PI / 180), 1, 967, 100);
            ctx.rotate(6.9 * (Math.PI / 180));

            ctx.fillText((time.getMonth()+1)+ "月"+time.getDate()+"日", 370, 35);

            ctx.fillStyle = "rgb(80,120,169)";
            for (var i = 32; i < 95; i++) {
                ctx.fillRect(40 + 7.5 * (i - 32), 20 + (300 - 300 * animData[i]), 4, 300 * animData[i]);
            }

            ctx.resetTransform();

            /*var greeting = "凌晨啦!";

            if (time.getHours() >= 6) {
                greeting = "早上好!";
            }

            if (time.getHours() >= 8) {
                greeting = "上午好!";
            }

            if (time.getHours() >= 11) {
                greeting = "你吃了吗";
            }

            if (time.getHours() >= 13) {
                greeting = "下午好鸭!";
            }

            if (time.getHours() >= 16) {
                greeting = "傍晚咯!";
            }

            if (time.getHours() >= 19) {
                greeting = "晚安!";
            }*/

            //手机
            ctx.transform(1.0911, -35 * (Math.PI / 180), 0, 0.5868, 1132.94, 564.07);
            ctx.rotate(56.5 * (Math.PI / 180));
            ctx.textAlign = "center";
            ctx.fillStyle = "#fff";
            ctx.font = "36pt Impact";
            ctx.fillText(greeting, 135, 100);
            ctx.textAlign = "start";

            ctx.resetTransform();

            //设置新图层处覆盖模式
            ctx.globalCompositeOperation = "overlay";
              
            //绘制高光条
            ctx.drawImage(light, 971, 197);
            ctx.globalCompositeOperation = "source-over";

            //绘制22手办
            ctx.drawImage(caidai, 949, 25);
            ctx.drawImage(two, 1319, 345);

            displayCtx.drawImage(cvs, 0, 0, display.width, display.height);
            window.requestAnimationFrame(render);
        }

        window.requestAnimationFrame(render);
    </script>
</body>

</html>
